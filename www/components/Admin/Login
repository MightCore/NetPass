<%doc>
# $Header: /tmp/netpass/NetPass/www/components/Admin/Login,v 1.11 2005/05/06 03:09:33 jeffmurphy Exp $

#   (c) 2004 University at Buffalo.
#   Available under the "Artistic License"
#   http://www.gnu.org/licenses/license-list.html#ArtisticLicense

This component outputs a login prompt form. It returns 1 if the user has successfully
logged in, otherwise it returns 0.

</%doc>


<%args>
        $username  => undef;
        $password  => undef;
	$wherefrom => undef;
</%args>

<%perl>
#use Data::Dumper; print "<PRE>", Dumper($m->session), "</PRE>";

	return 1 if (exists $m->session->{'logged_in'} && 
			($m->session->{'logged_in'} == 1));

	delete $m->session->{'username'};
	delete $m->session->{'my_groups'};

	my $ip = $ENV{'REMOTE_ADDR'};

        if (defined($username) && ($username ne "")) {
	    	my $aok = $np->authenticateAdmin($username,
        		                        $password);

		if (defined($aok) && ($aok == 1)) {
			_log("INFO", $username." is logging in to Admin tool\n");
			$m->audit(-severity => 'NOTICE', -ip => $ENV{'REMOTE_ADDR'},
				-user => $username, -msg => [ "$username logged in to Admin tool" ]);
			$m->session->{'logged_in'} = 1; # FIX/Client/Login
			$m->session->{'username'}  = $username;
			$m->session->{'my_groups'} = $np->db->getUserGroups($username);
			my $uri = $r->uri;
			if ($uri =~ /^\/Admin/) {
				$m->redirect($uri);
			} else {
				$m->redirect('/Admin/index.mhtml');
			}

                	return 1;
                } else {
                        print "<center>Authentication failed.</center><P>";
                }
        } 
</%perl>

<form method="post" name="mainForm">
 <table align=center border='0' width='300'>
   <tr><th align=center colspan=2>Login</th></tr>
   <tr><td><%$np->cfg->policy(-key => 'USERNAME_PROMPT', -network => $ip) || "Username:"%></td>
       <td><input name="username" size=8></td>
   </tr>
   <tr><td><%$np->cfg->policy(-key => 'PASSWORD_PROMPT', -network => $ip) || "Password:"%></td>
       <td><input type=password name="password" size=8></td>
   </tr>
   <tr><td colspan=2 align=center><input type="submit" value="Login"></td></tr>
 </table>
<input type=hidden name=JavaScript value=''>
</form>

<script language="JavaScript"><!--
document.mainForm.JavaScript.value = 'enabled';
//--></script>

<%perl>
        return 0;
</%perl>
