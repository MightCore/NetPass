<%doc>
</%doc>
<%args>
	$enabledWhenLocked => '';
</%args>

<script language="JavaScript">
<!--
var lockOpPending = false;

function lockConfig_results(r) {
	var b = document.getElementById('lockButton');
	if (b) {
		b.disabled = '';
		b.innerHTML = "Lock Config";
	}
	lockOpPending = false;
	var ra = r.split(/\s/);

	if (ra[0] == "OK") {
		// something succeeded
		if (ra[1] == "lock") {
			// we got the lock, change button to
			// green and text to 'unlock'
			b.style.backgroundColor = '#77FF77';
			b.innerHTML = 'Config is Locked (by you)<BR>Unlock Config';
			adjust_onClick(b, "return lockConfig(0, 0);");
		} else {
			// we got the unlock, button -> yellow
			// text -> 'lock'
			b.style.backgroundColor = '#FFFF77';
			b.innerHTML = 'Config is Unlocked<BR>Lock Config';
			adjust_onClick(b, "return lockConfig(1, 0);");
		}
	} else {
		// something failed
//alert(r + " ral:" + ra.length + ' 1:' + ra[0] + ' 2:' + ra[1] + ' 3:' + ra[2]);

		if (ra[1] == "lock") {
			// we didnt get the lock, change button to
			// red and text to 'force lock'
			b.style.backgroundColor = '#FF7777';
			b.innerHTML = 'Config is Locked by '+ra[2]+'<BR>Force Lock Config';
			adjust_onClick(b, "return lockConfig(1, 1);");
		} else {
			// we didnt get the unlock, 
			// button -> red
			// text -> 'force unlock'
			b.style.backgroundColor = '#FF7777';
			b.innerHTML = 'Config is Locked by '+ra[2]+'<BR>Force Unlock Config';
			adjust_onClick(b, "return lockConfig(0, 1);");
		}
	}
}

function lockConfig(lock, force) {
	// lock: 0 = unlock, 1 = lock
	// force: 0 = no, 1 = yes

	if (lockOpPending) return;

	var b = document.getElementById('lockButton');
	if (b) {
		b.innerHTML = "Wait ...";
		adjust_onClick(b, "return false;");
		b.disabled = true;
	}

	lockOpPending = true;
	var url = "lockcfg.mhtml?printable=2&lock="+lock +"&force="+force;
	xmlhttp.open("GET", url , true);
	xmlhttp.onreadystatechange=function() {
		if (xmlhttp.readyState == 4) {
			lockConfig_results(xmlhttp.responseText);
		}
	};
	xmlhttp.send(null);
	return false;
}

function lockConfig_show_unlock() {
	var b = document.getElementById('lockButton');
}

function adjust_onClick(obj, fn) {
	if (browserType_IE) {
		obj.onclick = eval("x=function(e){"+fn+"}");
	} else {
		obj.setAttribute('ONCLICK', fn);
	}
}


-->
</script>
<style>
DIV.unlockedButton {
	text-align: center;
	width: 10em;
	float: right;
	display: block;
	border: outset 2px black;
	padding: 2px 5px 2px 5px;
	background-color: #FFFF77;
	cursor: pointer;
}
</style>

<div onclick="return false;" id='lockButton'
	class='unlockedButton'>Thinking ...</div> 

<!--<div class='unlockedButton'>Testing<BR>Foobar</div>-->

<%perl>
my $lstat = $np->db->isConfigLocked();

if (ref($lstat) eq "HASH") { 
	# the config is locked
	if ($lstat->{'user'} eq $m->session->{'username'}) {
		# by us, so show the unlock button
		print qq{<script>lockConfig_results("OK lock");</script>};
	} else {
		# but not by us, show the force unlock button
		print qq{<script>lockConfig_results("NOK lock $lstat->{'user'}");</script>};
	}
} 
elsif ($lstat) {
	# there was a problem
} 
else {
	# the config is not locked, show the lock button
	print qq{<script>lockConfig_results("OK unlock");</script>};
}
</%perl>
