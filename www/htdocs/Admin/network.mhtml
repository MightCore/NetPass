<%doc>
DESCRIPTION

This form allows you to:

 - add/remove networks
 - configure per-network settings
	- comment
	- ha enabled/disabled + settings
	- garp enabled/disabled + settings
	- netgroup membership
	- interface
	- nonquar/quar vlan id
	- switches
 - configure perl-network policy
	- any of the policy settings

PERMISSIONS

	RW	default/Admin
	RO	none
</%doc>
<%args>
	$submitButton => '';
	$network => '';
</%args>
<%perl>

my ($isRoot, $junk) = $m->comp('/Admin/MemberOf', 'acl' => [ 'Admin' ], 'group' => 'default');
if (!$isRoot) {
	print qq{<p class='error'>Sorry, you don't have access to this form.};
	return;
}

my $ip = $ENV{'REMOTE_ADDR'};
my $whoami = $m->session->{'username'};

# fetch all known networks and netgroups

my $allNetworks = $np->cfg->getNetworks();
my $allNetgroups = ();
foreach my $nw (@$allNetworks) {
        my $ng = $np->cfg->getNetgroup(-network => $nw);
        push @$allNetgroups, $ng if ($ng ne "") && (!grep(/^$ng$/, @$allNetgroups));
}
$m->comp('/Admin/LockConfig', 'enableWhenLocked' => [ 'addNetwork', 'submitButton' ], 'init' => 0);
my $WH = "--Select a Network--";

</%perl>

<h2> Network Configuration </h2>


Notes:
<ul>
<li>Networks are in CIDR notation (A.B.C.D/M)
<li>To add a new network:
<ol>
  <li> Click inside the "Add Network.." box. 
  <li> Type in a network name (CIDR notation only)
  <li> Click 'Commit Changes'
</ol>
<LI>To edit a network (once it's been added):
<ol>
  <li>Select the network from the drop-down menu.
  <LI>Edit it's parameters.
  <li>Click 'Commit Changes'
</ol>
</ul>

<script language='JavaScript'><!--
setWhereAmI('Configuration &gt; Network');
DBG_init();
--></script>


<form method="post">
<table border=0>
<tr>
    <td>
       <%$q->popup_menu(-id => 'network', -name => 'network',  -values => [ $WH, sort @$allNetworks ], -onchange => 'network_onchange_network();')%>
    </td>
    <td>
	<input id='addNetwork' name='addNetwork' size=20 value='Add Network...' disabled
	onblur='network_onblur_addNetwork(this);' onfocus='network_onfocus_addNetwork(this);'>
    </td>
    <td>
	<input type='submit' name='submitButton' id='submitButton' value='Commit Changes' disabled>
    </td>
</tr>
% if ($network) {
<tr><td colspan=3><PRE>
	- comment
	- ha enabled/disabled + settings
		- primary-redirector
		- secondary-redirector
		- servers
		- virtualip
	- garp enabled/disabled + settings
		- delay
		- number
	- netgroup membership (uneditable list + link)
	- interface
	- nonquar/quar vlan id
	- switches (list + add new + link to switch config)</PRE>
</td></tr>
<tr><td colspan=3>
%       my $ng = $np->cfg->getNetgroup(-network => $network);
%       my $ngtxt = $ng ? qq{<BR>(Part of the "<a href='netgroups.mhtml?netgroups=$ng'>$ng</a>" netgroup)} : "";
% 	$m->comp('/Admin/TableEditPolicy', %ARGS, 'tableName' => 'Network General Settings for '.$network.$ngtxt, 
%		 'showDefault' => 1, 'formatFor' => 'network', 
%		 'network' => $network, 'suppressKeys' => { 'PID_DIR' => 1, 'BASE_DIR' => 1 } );
% }
</td></tr>
</table>
</form>



<script src="/resources/js/common.js" type="text/javascript"></script>
<script src="/resources/js/network.js" type="text/javascript"></script>


<%perl>
my $lstat = $np->db->isConfigLocked();

if (ref($lstat) eq "HASH") { 
	# the config is locked
	if ($lstat->{'user'} eq $m->session->{'username'}) {
		# by us, so show the unlock button
		print qq{<script>lockConfig_results("OK lock");lockConfig_enableElements();</script>};
	} else {
		# but not by us, show the force unlock button
		print qq{<script>lockConfig_results("NOK lock $lstat->{'user'}");lockConfig_disableElements();</script>};
	}
} 
elsif ($lstat) {
	# there was a problem
} 
else {
	# the config is not locked, show the lock button
	print qq{<script>lockConfig_results("OK unlock");lockConfig_disableElements();</script>};
}

</%perl>
