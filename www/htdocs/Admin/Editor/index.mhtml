
<%doc>
# $Header: /tmp/netpass/NetPass/www/htdocs/Admin/Editor/index.mhtml,v 1.4 2005/04/19 04:01:25 jeffmurphy Exp $

#   (c) 2004 University at Buffalo.
#   Available under the "Artistic License"
#   http://www.gnu.org/licenses/license-list.html#ArtisticLicense
</%doc>

<%args>
$name    => '';
$network => '';
$ta      => '';
$search  => '';
$group   => '';
$submit  => '';
</%args>


<script><!--
setWhereAmI('Message Editor');
--></script>

<%perl>

print $q->h2("Message Editor");

my @rwGroups = ('Admin', 'Editor');
my @roGroups = ('Reports');
my $readOnly = "disabled";

my ($isReadonly, $roGroups) = $m->comp('/Admin/MemberOf', 'acl' => [ @roGroups ]);
my ($isAdmin, $rwGroups) = $m->comp('/Admin/MemberOf', 'acl' => [ @rwGroups ]);
my $isRoot = $m->comp('/Admin/MemberOf', 'acl' => [ 'Admin' ], 'group' => 'default');

if ($isAdmin) {
        $readOnly = "";
} elsif ($isReadonly) {
        $readOnly = "disabled";
} else {
        print $q->p({-class=>'error'},
                "Sorry, permission denied.<BR>You must be in one of these groups: ",
                join(',', @rwGroups, @roGroups));
        return;
}

print $q->start_form();

my $pageList = $np->db->getPageList();

my %allGroups = map { $_ => $_ } @{$pageList->{'group'}};

# XXX if you are !default->Admin then strip out groups that you dont 
# belong too

if (! $isRoot) {
	foreach my $grp (@$roGroups, @$rwGroups) {
		print "Strip group: $grp<BR>";
	}
}

print $q->table({-border=>0, -width=>600},
		$q->TR($q->td({-colspan=>2, -align=>"right"}, 

                ($readOnly eq "")?$q->a({-href=>"edit.mhtml"}, "[ Add New Message ]"):""
		)).

		$q->TR(
			$q->th({-colspan=>2}, "Search for messages:")
		).
		$q->TR(
			$q->td({-class=>"gray"}, "Name:") .
			$q->td({-class=>"gray"},
				$q->textfield(
						-name 	=> "name",
						-value 	=> $name
				)
			)
		).
		$q->TR(
			$q->td({-class=>"gray"}, 'Group:') .
			$q->td({-class=>"gray"},
				$q->popup_menu(
						-name 	=> "group",
						-values => [ sort keys %allGroups ]
				)
			)
		).
		$q->TR(
			$q->td({-class=>"gray"}, '&nbsp;') .
			$q->td({-class=>"gray"},
				$q->submit(
						-name 	=> "search",
						-value 	=> "Search"
				)
			)
		)

	);

return if(!$submit && !$search);

if($submit) {
        if ($readOnly eq "") {
		savePage($dbh, $name, $ta);
		print $q->p("Your changes have been saved...");
        } else {
                # this really shouldnt happen. we dont give them a submit button
                $np->db->audit(  -user => $m->session->{'username'},
                                	-severity => "ALERT",
	                                -msg => [ "tried to change a Message but is ReadOnly" ]);

        }
}

my ($results, $count) = getMessages($dbh, $name, $group);

if($count<0) {
	print ("<P class='error'>Sorry, there was an error while processing your request!</P>");
}

print $q->h4("Your search returned $count result(s)");

if($count==0) {
	print $q->p("You may want to re-define your search to be less strict.");
	return;
}

my @rows = ();

push(@rows, 	$q->TR(
			$q->th("Name") .
			$q->th("Edit") 
		)
);

my $class = "";

while (my $row = $results->fetchrow_hashref() ) {

	$class = ($class eq "")?"gray":"";
	
	my $href = "edit.mhtml?name=" . $row->{name}."&group=".$row->{'network'};
	if ($readOnly eq "disabled") {
		$href = "view.mhtml?name=" . $row->{name}."&group=".$row->{'network'};
	}

	my $delLink = "";

	#if ($readOnly eq "") {
	#	$delLink = $q->td(({-align=>'center'}, $q->submit(-name => 'submit', -value => 'Delete')));
	#}

	push( @rows,	$q->TR( {-class=> $class },
				$q->td({-align=>'center'}, $row->{name}) . 
				$q->td({-align=>'center'}, $q->a({-href=>$href}, 
					($readOnly eq "")?"[ edit ]":"[ view ]"
				))
			) . "\n");
}

$results->finish();

print $q->table({-width=>'80%'}, @rows);
print $q->end_form();

print $q->p();

return;

#######################

sub getMessages {
	my $dbh	   = shift;
	my $name   = shift;
	my $group  = shift;

	my @clause = ();
	my @params = ();

	if($name) {
		push(@clause, "name LIKE ?");
		push(@params, "%$name%");
	}

	if($group) {
		push(@clause, "network = ?");
		push(@params, $group);
	}

	my $query = "SELECT name, network FROM pages";
	
	if($#clause>-1) {
		$query .= " WHERE " . join(" AND ", @clause)
	}

	$query .= " ORDER BY name LIMIT 150";

	my $sth = $dbh->prepare($query);

	if(!defined($sth)) {
        	return ("prepare failed: ". $dbh->errstr, -1);
    	}
    
	if( !$sth->execute(@params) ) {
        	return ("execute failed: ". $dbh->errstr, -1);
    	}

    	my $count = $sth->rows;

	return ($sth, $count);

}

sub savePage {
	my $dbh     = shift;
	my $name    = shift;
	my $content = shift;

	$np->db->audit(
		-user => $m->session->{'logged_in'},
	      	-msg => [ "MessageEdit: $name editted" ]);

	my $ins_query = "INSERT IGNORE INTO pages (content, name) values (?,?)";
	my $upd_query = "UPDATE pages SET content=? WHERE name = ?";

	my $ins_sth   = $dbh->prepare($ins_query);
	my $upd_sth   = $dbh->prepare($upd_query);

	$ins_sth->execute($content, $name);
	$ins_sth->finish;
	$upd_sth->execute($content, $name);
	$upd_sth->finish;

}


</%perl>


