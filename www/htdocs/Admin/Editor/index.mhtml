
<%doc>
# $Header: /tmp/netpass/NetPass/www/htdocs/Admin/Editor/index.mhtml,v 1.5 2005/04/27 03:54:08 jeffmurphy Exp $

#   (c) 2004 University at Buffalo.
#   Available under the "Artistic License"
#   http://www.gnu.org/licenses/license-list.html#ArtisticLicense
</%doc>

<%args>
$name    => '';
$ta      => '';
$search  => '';
$group   => '';
$submit  => '';
</%args>


<script><!--
setWhereAmI('Message Editor');
--></script>

<%perl>

print $q->h2("Message Editor");

my @rwGroups = ('Admin', 'Editor');
my @roGroups = ('Reports');
my $readOnly = "disabled";

my ($isRO, $roGroups) = $m->comp('/Admin/MemberOf', 'acl' => [ @roGroups ]);
my ($isRW, $rwGroups) = $m->comp('/Admin/MemberOf', 'acl' => [ @rwGroups ]);
my ($isRoot, $junk)   = $m->comp('/Admin/MemberOf', 'acl' => [ 'Admin' ], 'group' => 'default');
my ($allMyRO, $allMyRW);
($junk, $allMyRO) = $m->comp('/Admin/MemberOf', 'acl' => [ @roGroups ]);
($junk, $allMyRW) = $m->comp('/Admin/MemberOf', 'acl' => [ @rwGroups ]);

if ($isRW) {
        $readOnly = "";
} elsif ($isRO) {
        $readOnly = "disabled";
} else {
        print $q->p({-class=>'error'},
                "Sorry, you don't have access to this form.<P>");
        return;
}

print $q->start_form();

my $pageList = $np->db->getPageList();

my %allGroups = map { $_ => $_ } @{$pageList->{'group'}};


if (! $isRoot) {
	# 'default' is added so you can at least see the default
	# messages (assuming you dont have any default perms). 
	# we won't allow you to edit them tho.

	%allGroups = map {$_ => $_} ('default', @$allMyRO, @$allMyRW);
}

print "You have permission to <B>edit</B> the messages in the following groups: ", join(', ', @$allMyRW), "<BR>"
	if ($#{$allMyRW} > -1);

print "You have permission to <B>view</B> the messages in the following groups: ";

if ($#{$allMyRO} > -1) {
	print join(', ', @$allMyRO);
	print ", default" if (grep !/^default$/, @$allMyRO);
	print "<BR>";
} else {
	print "default<BR>";
}


print $q->table({-border=>0, -width=>600},
		$q->TR($q->td({-colspan=>2, -align=>"right"}, 

                ($readOnly eq "")?$q->a({-href=>"edit.mhtml"}, "[ Add New Message ]"):""
		)).

		$q->TR(
			$q->th({-colspan=>2}, "Search for messages:")
		).
		$q->TR(
			$q->td({-class=>"gray"}, "Name:") .
			$q->td({-class=>"gray"},
				$q->textfield(
						-name 	=> "name",
						-value 	=> $name
				)
			)
		).
		$q->TR(
			$q->td({-class=>"gray"}, 'Group:') .
			$q->td({-class=>"gray"},
				$q->popup_menu(
						-name 	=> "group",
						-values => [ sort keys %allGroups ]
				)
			)
		).
		$q->TR(
			$q->td({-class=>"gray"}, '&nbsp;') .
			$q->td({-class=>"gray"},
				$q->submit(
						-name 	=> "search",
						-value 	=> "Search"
				)
			)
		)

	);

return if(!$submit && !$search);

if($submit) {
	my $rv = savePage($allMyRW, $name, $group, $ta, ($submit eq " Save Copy "));
	print $q->p({-class=>'error'}, $rv);
}

my $pl = $np->db->getPageList(-name => $name, -group => $group);
if (ref($pl) ne "HASH") {
	print ("<P class='error'>Sorry, there was an error while processing your request ($pl).</P>");
} else {
	my $count = $#{$pl->{'name'}} + 1;
	my $class = "";

</%perl>
	<h4>Your search returned <%$count%> result(s)</h4>
%	if ($count) {

		<table>
		<tr><th>Name</th><th>Group</th><th colspan=3>Operation</th></tr>

%		for(my $row = 0 ; $row <= $#{$pl->{'name'}} ; $row++) {
%			$class = ($class eq "")?"gray":"";
%			my $rwHref = "edit.mhtml?name=" . $pl->{'name'}->[$row]."&group=".$pl->{'group'}->[$row];
%			my $roHref = "view.mhtml?name=" . $pl->{'name'}->[$row]."&group=".$pl->{'group'}->[$row];
%			my $delLink = "";

			<tr class="<%$class%>">
			<td width='50%'><%$pl->{'name'}->[$row]%></td>
			<td width='25%'><%$pl->{'group'}->[$row]%></td>
%			if (grep /^$pl->{'group'}->[$row]$/, @$rwGroups) {
				<td width='8%'><a href="<%$rwHref%>">[ edit ]</a></td>
				<td width='8%'><a href="">[ del ]</a></td>
%			} else {
				<td width='8%'> </td>
				<td width='8%'> </td>
%			}
			<td width='8%'><a href="<%$roHref%>">[ view ]</a></td>
			</tr>
%		}
		</table>
%	}
%}

</form>
<P>

<%perl>
return;

sub savePage {
	my $rw      = shift;
	my $name    = shift;
	my $group   = shift;
	my $content = shift;
	my $noupdate = shift;

	# enforce permissions

	if (grep /^$group$/, @$rw) {

		$np->db->audit(
			-user => $m->session->{'username'},
	      		-msg => [ "MessageEdit: $name ($group) editted" ]);

		my $rv = $np->db->setPage(-name => $name, -group => $group,
					  -content => $content, -noupdate => $noupdate);

		if ($rv =~ /duplicate/i) {
			return "Save failed. Duplicate entry. Did you use 'Save Copy' but forget to change the name?";
		}
		return $rv if ($rv); # error
		return "Page saved.";
	}

	# else you dont have permission

	$np->db->audit( -user => $m->session->{'username'}, -severity => "ALERT",
			-msg => [ "tried to edit $name ($group) but doesnt have permission to do so" ]);

	return "You dont have the appropriate permissions to edit this message.";
}



</%perl>


