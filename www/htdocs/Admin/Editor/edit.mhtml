<%doc>
# $Header: /tmp/netpass/NetPass/www/htdocs/Admin/Editor/edit.mhtml,v 1.3 2005/04/19 04:01:24 jeffmurphy Exp $

#   (c) 2004 University at Buffalo.
#   Available under the "Artistic License"
#   http://www.gnu.org/licenses/license-list.html#ArtisticLicense

</%doc>

<%args>
$name     => '';
$content  => '';
$nameForm => '';
$group    => '';
$submit   => '';
</%args>

<script><!--
setWhereAmI('Message Editor &gt; <%$name%>');
--></script>

<%perl>

my @rwGroups = ('Admin', 'Editor');
my @roGroups = ('Reports');
my $readOnly = "disabled";

my ($isReadonly, $roGroups) = $m->comp('/Admin/MemberOf', 'acl' => [ @roGroups ]);
my ($isAdmin, $rwGroups) = $m->comp('/Admin/MemberOf', 'acl' => [ @rwGroups ]);
my $isRoot = $m->comp('/Admin/MemberOf', 'acl' => [ 'Admin' ], 'group' => 'default');

if ($isAdmin) {
        $readOnly = "";
} elsif ($isReadonly) {
        $readOnly = "disabled";
} else {
        print $q->p({-class=>'error'},
                "Sorry, permission denied.<BR>You must be in one of these groups: ",
                join(',', @rwGroups, @roGroups));
        return;
}

if($name && $group) {
	$content = $np->db->getPage(-name => $name, -group => $group);

	if(!defined($content)) {
        	print $q->error("Sorry, there was an error while processing your request!");
		return;
	}
}

my $pageList = $np->db->getPageList();
my %allGroups = map { $_ => $_ } @{$pageList->{'group'}};

if ($submit eq " Save Change ") {
	my $rv = $np->db->setPage(-name => $name, -group => $group, -content => $content);
	if ($rv) {
		print "<P class='error'>Failed to update page: $rv</P>";
	}
} 
elsif($submit eq " Save Copy ") {
	my $rv = $np->db->setPage(-name => $name, -group => $group, -content => $content, -noupdate => 1);
	if ($rv) {
		print "<P class='error'>Failed to update page: $rv (did you remember to change the name or group?)</P>";
	}
}


</%perl>

<script type="text/javascript">
  _editor_url = "/Admin/Editor/htmlarea";
  _editor_lang = "en";
</script>

<script type="text/javascript" src="htmlarea/htmlarea.js"></script>

<script type="text/javascript">
      HTMLArea.loadPlugin("TableOperations");
      HTMLArea.loadPlugin("FullPage");
      HTMLArea.loadPlugin("ContextMenu");
</script>

<style type="text/css">
textarea { background-color: #fff; border: 1px solid 00f; }
</style>

<script type="text/javascript">
var editor = null;
function initEditor() {
  // create an editor for the "ta" textbox
  editor = new HTMLArea("ta");

//  editor.config.hideSomeButtons(" fontname fontsize textindicator showhelp about popupeditor ");
  editor.config.hideSomeButtons(" showhelp about popupeditor ");

  // register the FullPage plugin
  editor.registerPlugin(FullPage);

  // register the SpellChecker plugin
  editor.registerPlugin(TableOperations);

  // add a contextual menu
  editor.registerPlugin("ContextMenu");

  setTimeout(function() {
    editor.generate();
  }, 10);
  return false;
}

</script>

<body onload="initEditor()">

<form action="index.mhtml" method="post" id="edit" name="edit">
<%perl>
	print $q->b("Name: ") . $q->textfield( 	-name     => "name",
						-value	  => $name,
						-required => 1
					);

	print $q->b("Group: ") . $q->popup_menu( 	-name     => "group",
							-values	  => [ sort keys %allGroups ],
							-default  => $group
					);

</%perl>

<textarea id="ta" name="ta" style="width:100%" rows="24" cols="80">
<% $content %>
</textarea>

<p />

<input $readOnly type="submit" name="submit" value=" Save Changes " />
<input $readOnly type="submit" name="submit" value=" Save Copy " />
<input type="button" name="cancel" value=" Cancel " onClick="top.location='index.mhtml'"/>

</form>

