
<%doc>
# $Header: /tmp/netpass/NetPass/www/htdocs/Admin/user.mhtml,v 1.9 2005/04/19 20:53:05 jeffmurphy Exp $

#   (c) 2004 University at Buffalo.
#   Available under the "Artistic License"
#   http://www.gnu.org/licenses/license-list.html#ArtisticLicense


functions:
	1) add a user
	2) delete a user
	3) change user's groups
</%doc>

<%args>
	$submit  => undef;
	$aclHash => undef;
</%args>

<script><!--
setWhereAmI('User Editor');
--></script>

<%perl>
if ($submit eq "Commit Changes") { 
	print "submit: ".$aclHash."<P>";
	my $uh = {};
	foreach my $part (split (';', $aclHash)) {
		if ($part ne "") {
			my @ap = split(/\$/, $part);
			if ($#ap == 3) {
				if (ref($uh->{$ap[1]}->{$ap[2]}) eq "ARRAY") {
					push @{$uh->{$ap[1]}->{$ap[2]}}, $ap[3];
				} else {
					$uh->{$ap[1]}->{$ap[2]} = [ $ap[3] ];
				}
			}
		}
	}
	$np->db->setUsersAndGroups(-userhash => $uh, -whoami => $m->{'session'}->{'username'},
					-ip => $ENV{'REMOTE_ADDR'});
}
</%perl>

<script src="/resources/js/xmlhttp.js" type="text/javascript"></script>
<script src="/resources/js/userform.js" type="text/javascript"></script>
<script src="/resources/js/debug.js" type="text/javascript"></script>
<script language="JavaScript">
DBG_init();
var userhash = {
<%perl>
	my $users  = $np->db->getUsersAndGroups();
	my ($comma1, $comma2, $comma3) = ("", "", "");
	foreach my $user (sort keys %$users) {
		print "$comma1\n\t'$user' : {\n";
		$comma2 = "";
		foreach my $group (sort keys %{$users->{$user}}) {
			print "$comma2\n\t\t'$group' : ";
			if (ref($users->{$user}->{$group}) ne "ARRAY") {
				print "1";
				$comma2 = ",";
			} else {
				print "{\n";
				$comma3 = "";
				#for(my $i = 0 ; $i < $#{$users->{$user}->{$group}} ; $i++) {
				foreach my $acl (sort @{$users->{$user}->{$group}}) {
					print "$comma3\n\t\t\t'$acl' : 1";
					$comma3 = ",";
				}

				print "\t\t}";
				$comma2 = ",";
			}
		}
		print "\t}";
		$comma1 = ",";
	}
</%perl>
};
</script>

<form method="post">

<table>
<tr><td colspan=2>
<%perl>
	# these are reserved group names.

	my %groups = ( 'Admin' => 1, 'ScanAdmin' => 1, 'Editor' => 1, 'Reports' => 1,
			'UserEditor' => 1, 'QuarAdmin' => 1, 'NetAdmin' => 1 );
	my @groups = (keys %groups);

	my $error  = "";

	my $whoami = $m->session->{'username'};
	my $myip   = $ENV{'REMOTE_ADDR'};

	my $ldap   = $np->cfg->policy('LDAP_USER_QUERY', $ENV{'REMOTE_ADDR'});


	if( defined($users) ) {
		my $widthHolder = "-" x 32;
</%perl>

<table id='userEditor'>
<tr><th>User</th><th>Groups</th><th>Access Type</th></tr>
<tr><td style='vertical-align:top;'>
	    <select size="25" id="UserList" name="UserList" 
		onchange="userform_changeToUser(this); return false;">
			<option disabled name='width'><%$widthHolder%>
%			foreach my $user (sort keys %$users) {
			<option value="<%$user%>"> <%$user%>
%			}
    </select>
    <P><center><input id='addUser' 
		onfocus='userform_onfocus_addUser(this); return false;'
		onblur='userform_onblur_addUser(this); return false;'
	        size=10 maxlength=16 value="Add user..."><P>
       <button id='deleteUser' disabled>Delete User</button></center>
    </td>
    <td style='vertical-align:top;'>
	    <select multiple size="15" id="GroupList" name="GroupList" multiple
		onchange="userform_showACLforGroup(this); return false;">
		<option disabled name='width'><%$widthHolder%>
	    </select>
	    <BR><center><button onClick="userform_addGroupToUser(); return false;">^</button> 
		        <button onClick="userform_remGroupFromUser(); return false;">v</button><BR>
			Available Groups:
		</center>

	    <select multiple size="15" id="AvailableGroupList" name="AvailableGroupList" multiple
		onchange="userform_onchange_availableGroups(); return false;">
		<option disabled name='width'><%$widthHolder%>
<%perl>
		my %groupsList;
		foreach my $user (sort keys %$users) {
			foreach my $nw (sort keys %{$users->{$user}}) {
				next if exists $groups{$nw};
				$groupsList{$nw} = 1;
			}
		}
		foreach my $gl (sort keys %groupsList) {
			print qq{<option value="$gl"> $gl\n};
		}
</%perl>
</select><P><center>
<input type='submit' value='Commit Changes' name='submit'></center><P>


</td>
<td style='vertical-align:top;'>
<select multiple size="25" id="AccessControlList" name="AccessControlList" multiple
 onchange="userform_editACL(); return false;">
<option disabled name='width'><%$widthHolder%>
%		foreach my $gl (sort @groups) {
	<option value="<%$gl%>"> <%$gl%>
%		}
</select>
<P><CENTER>
<button id='addToAll' disabled>Add To All</button><P>
<button id='remFromAll' disabled>Remove From All</button>

</CENTER>
</td></tr></table>

<textarea style="display: NONE;" name="aclHash" id="aclHash" cols=80 rows=24></textarea>
%	}

<script>userform_setAclHash();</script>

<dl>
 <dt> Admin </dt>
 <dd> Full access to all functions and pages. </dd>
 
 <dt> ScanAdmin </dt>
 <dd> Read/write access to the Scan (Nessus) configuration page and the
      IDS (Snort) configuration page. </dd>

 <dt> Editor </dt>
 <dd> Read/write access to the Message Editor page. </dd>

 <dt> Reports </dt>
 <dd> Read only access to:
     <ul>
 	<li> Message Editor </li>
	<li> ScanAdmin </li>
	<li> Audit Logs </li>
	<li> Statistics </li>
     </ul></dd>

 <dt> User </dt>
 <dd> Read/write access to the User page (this page) with the exception
      that you can not change or add Admin users. Only another Admin
      user can change/add an Admin user. </dd>

 <dt> QuarAdmin </dt>
 <dd> Read/write access to the Quarantine Control page. </dd>
</dl>
</form>
