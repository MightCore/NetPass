
<%doc>
# $Header: /tmp/netpass/NetPass/www/htdocs/Admin/user.mhtml,v 1.13 2005/04/20 20:57:20 jeffmurphy Exp $

#   (c) 2004 University at Buffalo.
#   Available under the "Artistic License"
#   http://www.gnu.org/licenses/license-list.html#ArtisticLicense


functions:
	1) add a user
	2) delete a user
	3) change user's groups
</%doc>

<%args>
	$submit  => undef;
	$aclHash => undef;
</%args>

<script><!--
setWhereAmI('User Editor');
--></script>

<%perl>

use Data::Dumper;

# there is no RO access to this form.

my @rwACLs = ('Admin', 'UserEditor');

my ($isAdmin, $rwGroups) = $m->comp('/Admin/MemberOf', 'acl' => [ @rwACLs ]);
my ($isRoot, $junk) = $m->comp('/Admin/MemberOf', 'acl' => [ 'Admin' ], 'group' => 'default');

if (!$isRoot && !$isAdmin) {
        print $q->p({-class=>'error'},
                "Sorry, permission denied.<BR>You must have one of: ".
                join(', ', @rwACLs). " permissions on at least one group to use this form.");
        return;
}

# these are reserved group names.

my %groups = ( 'Admin' => 1, 'ScanAdmin' => 1, 'Editor' => 1, 'Reports' => 1,
		'UserEditor' => 1, 'QuarAdmin' => 1 ); #, 'NetAdmin' => 1 );
my @groups = (keys %groups);
my $error  = "";
my $whoami = $m->session->{'username'};
my $myip   = $ENV{'REMOTE_ADDR'};
my $ldap   = $np->cfg->policy('LDAP_USER_QUERY', $ENV{'REMOTE_ADDR'});

# get a list of all networks

my $allNetworks = $np->cfg->getNetworks();

# and all netgroups

my $allNetgroups = ();
foreach my $nw (@$allNetworks) {
	my $ng = $np->cfg->getNetgroup($nw);
	push @$allNetgroups, $ng if ($ng ne "");
}

my $users  = $np->db->getUsersAndGroups();

my %groupsList;
my $gl;
my $user;

# come up with a uniq list of groups to present

foreach $user (sort keys %$users) {
	foreach my $nw (sort keys %{$users->{$user}}) {
		next if exists $groups{$nw};
		$groupsList{$nw} = 1;
	}
}

foreach my $nw (sort @$allNetworks, @$allNetgroups) {
	$groupsList{$nw} = 1;
}

if ($submit eq "Commit Changes") { 
	#print "submit: ".$aclHash."<P>";
	my $uh = {};
	foreach my $part (split (';', $aclHash)) {
		if ($part ne "") {
			my @ap = split(/\$/, $part);
			#print "ap $#ap<P>";
			if ($#ap == 3) {
				if (ref($uh->{$ap[1]}->{$ap[2]}) eq "ARRAY") {
					push @{$uh->{$ap[1]}->{$ap[2]}}, $ap[3];
				} else {
					$uh->{$ap[1]}->{$ap[2]} = [ $ap[3] ];
				}
			}
			elsif ($#ap == 2) {
				# user, group, but no ACL
				$uh->{$ap[1]}->{$ap[2]} = "";
			}
			elsif ($#ap == 1) {
				# user, no groups, no ACL (delete user)
				$uh->{$ap[1]} = "";
			}
		}
	}
	#print "<PRE>", Dumper($uh), "</PRE>";

	# at this point we have all the edits, but we want to ensure that
	# an admin for one group cant edit a user's ACL for another group.
	# we dont trust what is posted back to us, so we do the check here
	# rather than in the javascript code. 
	#	
	# to accomplish this we make two passes. one for the database 
	# list of users and one for the list of users submitted via
	# the web. the first pass adds any users/groups you are not allowed
	# to edit back into the "uh". the second pass removes any
	# invalid _new_ users/groups you added from the "uh".

	# we extract all users/groups and iterate over
	# them:
	#   1. for any user/group that you _do not_ have permissions for,
	#      we add it back into the userhash if it exists in the db
	#   2. if it does not exist in the db, we delete it from the
	#      hash.
	#
	# we then repeat using the "uh" to remove new, but invalid, users.


	if (!$isRoot) {
		my $mygrpRE = '^('.join('|', @$rwGroups).')$';

		print "<PRE>mygrpRE = $mygrpRE\n";

		print  Data::Dumper->Dump([$uh], [qw(fromweb)] ), "\n";

		foreach $user (keys %$uh) {
			print "PASS1 examining $user\n";

			if (! exists($users->{$user}) ) {
				print "\tthis is a new user. defer to PASS 2\n";
			}
			else {
				foreach my $bdgrp (keys %{$users->{$user}}) {
					if ($bdgrp !~ /$mygrpRE/) {
						print "\twe found a group $bdgrp that we arent allowed to edit\n";

						# we found a group we arent allowed to edit. if the group
						# already exists for $user in the database, then restore
						# the database data to "uh" just to be safe. if the group
						# does not exist for the user in the database, then delete
						# it from "uh".

						if (exists ($users->{$user}->{$bdgrp})) {
							print "\t\trestoring perms from db copy\n";
							$uh->{$user}->{$bdgrp} = $users->{$user}->{$bdgrp};
						} else {
							print "\t\tdeleting perms\n";
							delete $uh->{$user}->{$bdgrp};
						}
					}
				}
			}

			print "PASS2 examining $user\n";

			foreach my $bdgrp (keys %{$uh->{$user}}) {
				if ($bdgrp !~ /$mygrpRE/) {

					# at this point, any users we inspect should be _new_ users
					# so if the user exists in the db, we can skip it

					next if exists $users->{$user};

					print "\twe found a group $bdgrp that we arent allowed to edit\n";

					# drop bad groups, leaving only good groups

					print "\t\tdeleting perms from $user for $bdgrp\n";
					delete $uh->{$user}->{$bdgrp};
				}
			}
		}

		print  Data::Dumper->Dump([$users], [qw(fromdb)] ), "\n";
		print  Data::Dumper->Dump([$uh], [qw(final)] ), "\n";

		print "</PRE>";
	}

	
	#$np->db->setUsersAndGroups(-userhash => $uh, -whoami => $m->{'session'}->{'username'},
	#				-ip => $ENV{'REMOTE_ADDR'});
}
</%perl>

<script src="/resources/js/xmlhttp.js" type="text/javascript"></script>
<script src="/resources/js/userform.js" type="text/javascript"></script>
<script src="/resources/js/debug.js" type="text/javascript"></script>
<script language="JavaScript">
DBG_init();
var userhash = {
<%perl>
	my ($comma1, $comma2, $comma3) = ("", "", "");
	foreach my $user (sort keys %$users) {
		print "$comma1\n\t'$user' : {\n";
		$comma2 = "";
		foreach my $group (sort keys %{$users->{$user}}) {
			print "$comma2\n\t\t'$group' : ";
			if (ref($users->{$user}->{$group}) ne "ARRAY") {
				print "1";
				$comma2 = ",";
			} else {
				print "{\n";
				$comma3 = "";
				#for(my $i = 0 ; $i < $#{$users->{$user}->{$group}} ; $i++) {
				foreach my $acl (sort @{$users->{$user}->{$group}}) {
					print "$comma3\n\t\t\t'$acl' : 1";
					$comma3 = ",";
				}

				print "\t\t}";
				$comma2 = ",";
			}
		}
		print "\t}";
		$comma1 = ",";
	}
</%perl>
};
</script>

<form method="post">

<table>
<tr><td colspan=2>
<%perl>
	if( defined($users) ) {
		my $widthHolder = "-" x 32;
</%perl>

To delete a user, remove them from all groups. All users and groups are shown (and
in Internet Explorer they are editable too), however, you are only allowed to make
changes to the following groups: <P><UL>
<%perl>
	if ($isRoot) { 
		print "<LI> You have full Admin rights: you may edit the ACL for any group.\n";
	} else {
		print "<LI>", join("<LI>", @$rwGroups);
	}
</%perl>
</UL>

This will be enforced when you commit the changes.<P>

<table id='userEditor'>
<tr><th>User</th><th>Groups</th><th>Access Type</th></tr>
<tr><td style='vertical-align:top;'>
	    <select size="33" id="UserList" name="UserList" 
		onchange="userform_changeToUser(this); return false;">
			<option disabled name='width'><%$widthHolder%>
%			foreach $user (sort keys %$users) {
			<option value="<%$user%>"> <%$user%>
%			}
    </select>
    <P><center><input id='addUser' 
		onfocus='userform_onfocus_addUser(this); return false;'
		onblur='userform_onblur_addUser(this); return false;'
	        size=10 maxlength=16 value="Add user..."><BR>
           <I>Press TAB after entering username</I>
	   </center> 
    </td>
    <td style='vertical-align:top;'>
	    <select multiple size="15" id="GroupList" name="GroupList" multiple
		onchange="userform_showACLforGroup(this); return false;">
		<option disabled name='width'><%$widthHolder%>
	    </select>
	    <BR><center><button onClick="userform_addGroupToUser(); return false;">^</button> 
		        <button onClick="userform_remGroupFromUser(); return false;">v</button><BR>
			Available Groups:
		</center>

	    <select multiple size="15" id="AvailableGroupList" name="AvailableGroupList" multiple
		onchange="userform_onchange_availableGroups(); return false;">
		<option disabled name='width'><%$widthHolder%>
<%perl>
		foreach my $gl (sort keys %groupsList) {
			print qq{<option value="$gl"> $gl\n};
		}
</%perl>
</select><P><center>
<input type='submit' value='Commit Changes' name='submit'></center><P>


</td>
<td style='vertical-align:top;'>
<select multiple size="33" id="AccessControlList" name="AccessControlList" multiple
 onchange="userform_editACL(); return false;">
<option disabled name='width'><%$widthHolder%>
%		foreach $gl (sort @groups) {
	<option value="<%$gl%>"> <%$gl%>
%		}
</select>
<P><CENTER>
<button id='addToAll' disabled>Add To All</button><P>
<button id='remFromAll' disabled>Remove From All</button>

</CENTER>
</td></tr></table>

<textarea style="display: NONE;" name="aclHash" id="aclHash" cols=80 rows=24></textarea>
%	}

<script>
	userform_setAclHash();	
	userform_unHighLight("AccessControlList");
	userform_disableList("AccessControlList");
</script>

<HR>

If your group is 'default' then you have the specified permissions
for <I>all</I> groups (default permissions cascade). Otherwise, 
For the specified groups:

<dl>
 <dt> Admin </dt>
 <dd> Full access to all functions and pages. </dd>
 
 <dt> ScanAdmin </dt>
 <dd> Read/write access to the Scan (Nessus) configuration page and the
      IDS (Snort) configuration page. </dd>

 <dt> Editor </dt>
 <dd> Read/write access to the Message Editor page. </dd>

 <dt> Reports </dt>
 <dd> Read only access to:
     <ul>
 	<li> Message Editor </li>
	<li> ScanAdmin </li>
	<li> Audit Logs </li>
	<li> Statistics </li>
     </ul></dd>

 <dt> User </dt>
 <dd> Read/write access to the User page (this page) with the exception
      that you can not change or add Admin users. Only another Admin
      user can change/add an Admin user. </dd>

 <dt> QuarAdmin </dt>
 <dd> Read/write access to the Quarantine Control page. </dd>
</dl>
</form>
